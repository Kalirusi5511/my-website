<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Studio Dashboard â€“ Final Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root {
  --bg: #f4f4f4;
  --card: #fff;
  --text: #111;
  --btn: #4CAF50;
  --btn-h: #45a049;
  --owner: #e74c3c;
  --admin: #9b59b6;
}

body.dark {
  --bg: #121212;
  --card: #1e1e1e;
  --text: #eee;
  --btn: #3498db;
  --btn-h: #2980b9;
}

body {
  margin: 0;
  font-family: sans-serif;
  background: var(--bg);
  color: var(--text);
  padding: 12px;
}

.box {
  max-width: 900px;
  margin: auto;
  background: var(--card);
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 3px 8px rgba(0,0,0,.2);
}

input, select, button {
  width: 100%;
  padding: 10px;
  margin: 6px 0;
  border-radius: 6px;
  font-size: 15px;
}

button {
  background: var(--btn);
  color: #fff;
  border: none;
  font-weight: 700;
  cursor: pointer;
}

button:hover {
  background: var(--btn-h);
}

.hidden { display: none; }
.role-owner { color: var(--owner); font-weight: 700; }
.role-admin { color: var(--admin); font-weight: 700; }
hr { margin: 20px 0; }

.studio { border: 1px solid #ccc; padding: 10px; margin: 10px 0; border-radius: 6px; display:flex; justify-content: space-between; align-items:center; }
.studio h4 { margin: 0; flex-grow:1; }
.studio button { margin-left: 6px; }

#supportChat { max-height:200px; overflow:auto; border:1px solid #ccc; padding:6px; margin-bottom:6px; }
#tableRequests { margin-top:10px; }

table { border-collapse: collapse; margin-bottom: 15px; }
table th, table td { border: 1px solid #111; padding: 6px; text-align: center; }
table td { min-width: 50px; }

@media(max-width:600px){
  .box{padding:14px}
  input,button{font-size:16px}
}
</style>
</head>
<body>

<div class="box" id="loginBox">
  <h2>Login</h2>
  <input id="loginUser" placeholder="Name">
  <input id="loginPw" type="password" placeholder="Passwort">
  <button onclick="login()">Login</button>

  <h3>Registrieren</h3>
  <input id="regUser" placeholder="Name">
  <input id="regPw" type="password" placeholder="Passwort">
  <button onclick="register()">Registrieren</button>

  <!-- Startseiten-Button direkt auf Login-Seite -->
  <button id="startBtn" class="hidden" onclick="goStart()">Startseite</button>
</div>

<div class="box hidden" id="app">
  <h2 id="welcome"></h2>
  <p>Rolle: <span id="role"></span></p>

  <button id="darkBtn" onclick="toggleDark()">ðŸŒ™ Dark Mode</button>
  <button onclick="logout()">Logout</button>

  <hr>

  <h3>Passwort Ã¤ndern</h3>
  <input id="oldPw" type="password" placeholder="Altes Passwort">
  <input id="newPw" type="password" placeholder="Neues Passwort">
  <button onclick="changePw()">Ã„ndern</button>

  <div id="adminArea" class="hidden">
    <hr>
    <h3>Owner / Admin</h3>

    <h4>Benutzer freischalten</h4>
    <input id="newUserName" placeholder="Neuer Benutzername">
    <button onclick="createUser()">Freischalten</button>

    <h4>Passwort zurÃ¼cksetzen</h4>
    <input id="resetUser" placeholder="Benutzer">
    <input id="resetPw" type="password" placeholder="Neues Passwort">
    <button onclick="resetUserPw()">Reset</button>

    <h4>Support-Chat</h4>
    <div id="supportChat"></div>
    <input id="supportMsg" placeholder="Nachricht" style="width:80%; display:inline-block">
    <button onclick="sendSupportMsg()" style="width:18%; display:inline-block">Senden</button>

    <h4>Backup</h4>
    <button onclick="exportData()">Export</button>
    <input type="file" onchange="importData(this)">

    <h4>Tabellen-Anfragen der User</h4>
    <div id="tableRequests"></div>
  </div>

  <hr>
  <h3>Dein Studio-Bereich</h3>
  <div id="studios">Keine Studios vorhanden.</div>
  <input id="studioName" placeholder="Studio Name">
  <button onclick="addStudio()">Studio hinzufÃ¼gen</button>

  <hr>
  <h3>Tabellen anfragen</h3>
  <input id="reqTables" type="number" min="1" placeholder="Anzahl Tabellen">
  <button onclick="requestTables()">Anfrage senden</button>

  <hr>
  <h3>Deine Tabellen</h3>
  <div id="myTables">Noch keine Tabellen freigegeben.</div>
  <button onclick="saveTables()">Tabellen speichern</button>
</div>

<script>
// ======== Grundlogik ========
let users = JSON.parse(localStorage.getItem("users")) || [];
let currentUser = null;
const save = () => localStorage.setItem("users", JSON.stringify(users));

async function hash(t){
  const b = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(t));
  return [...new Uint8Array(b)].map(x => x.toString(16).padStart(2,"0")).join("");
}

// ======== Init ========
(async()=>{
  if(!users.some(u=>u.role==="owner")){
    let pw = prompt("Setze ein Passwort fÃ¼r den Owner:");
    if(!pw) pw = "default";
    users.push({name:"Owner", role:"owner", pwHash: await hash(pw), studios:[], support:[], requestedTables:0, approvedTables:0, tablesData:[]});
    save();
    alert("Owner-Passwort gesetzt!");
  }

  if(localStorage.getItem("dark")==="1") document.body.classList.add("dark");
  updateDarkBtn();
})();

// ======== Login / Register ========
async function login(){
  const n = loginUser.value.trim().toLowerCase();
  const u = users.find(x=>x.name.toLowerCase()===n);
  if(!u) return alert("User nicht gefunden");
  if(await hash(loginPw.value)!==u.pwHash) return alert("Falsches Passwort");

  currentUser = u;
  loginBox.classList.add("hidden");
  app.classList.remove("hidden");
  welcome.textContent = "Hallo "+u.name;
  role.textContent = u.role;
  role.className = u.role==="owner"?"role-owner":"role-admin";

  adminArea.classList.toggle("hidden", u.role==="member");
  renderStudios();
  renderSupport();
  renderRequests();
  renderMyTables();

  if(currentUser.role === "member"){
    document.getElementById("startBtn").classList.remove("hidden");
  }
}

async function register(){
  const n = regUser.value.trim();
  if(!n) return;
  if(users.some(u=>u.name.toLowerCase()===n.toLowerCase())) return alert("Existiert schon");
  users.push({name:n, role:"member", pwHash:await hash(regPw.value), studios:[], support:[], requestedTables:0, approvedTables:0, tablesData:[]});
  save();
  alert("Registriert");
}

// ======== Passwort ========
async function changePw(){
  if(await hash(oldPw.value)!==currentUser.pwHash) return alert("Falsch");
  currentUser.pwHash = await hash(newPw.value);
  save();
  alert("GeÃ¤ndert");
}

async function resetUserPw(){
  if(currentUser.role==="member") return;
  const u = users.find(x=>x.name===resetUser.value);
  if(!u) return alert("Nicht gefunden");
  u.pwHash = await hash(resetPw.value);
  save();
  alert("Reset OK");
}

// ======== Owner-Funktionen ========
function createUser(){
  const name = newUserName.value.trim();
  if(!name) return;
  if(users.some(u=>u.name.toLowerCase()===name.toLowerCase())) return alert("Existiert schon");
  users.push({name, role:"member", pwHash:"", studios:[], support:[], requestedTables:0, approvedTables:0, tablesData:[]});
  save();
  alert("User freigeschaltet!");
}

// ======== Studios mit Bearbeiten/LÃ¶schen ========
function renderStudios(){
  const container = document.getElementById("studios");
  container.innerHTML = "";
  if(!currentUser.studios) currentUser.studios = [];

  if(currentUser.studios.length===0){
    container.textContent = "Keine Studios vorhanden.";
    return;
  }

  currentUser.studios.forEach((s,i)=>{
    const div = document.createElement("div");
    div.className = "studio";
    const title = document.createElement("h4");
    title.textContent = s;
    div.appendChild(title);

    const editBtn = document.createElement("button");
    editBtn.textContent = "âœï¸ Bearbeiten";
    editBtn.onclick = ()=>editStudio(i);
    div.appendChild(editBtn);

    const delBtn = document.createElement("button");
    delBtn.textContent = "ðŸ—‘ LÃ¶schen";
    delBtn.onclick = ()=>removeStudio(i);
    div.appendChild(delBtn);

    container.appendChild(div);
  });
}

function addStudio(){
  const name = studioName.value.trim();
  if(!name) return;
  if(!currentUser.studios) currentUser.studios = [];
  currentUser.studios.push(name);
  save();
  renderStudios();
  studioName.value = "";
}

function removeStudio(idx){
  if(!confirm(`Studio "${currentUser.studios[idx]}" wirklich lÃ¶schen?`)) return;
  currentUser.studios.splice(idx,1);
  save();
  renderStudios();
}

function editStudio(idx){
  const newName = prompt("Studio-Name Ã¤ndern:", currentUser.studios[idx]);
  if(newName && newName.trim() !== ""){
    currentUser.studios[idx] = newName.trim();
    save();
    renderStudios();
  }
}

// ======== Support Chat ========
function sendSupportMsg(){
  const msg = supportMsg.value.trim();
  if(!msg) return;
  if(!currentUser.support) currentUser.support = [];
  currentUser.support.push({msg, time: new Date().toLocaleString()});
  supportMsg.value = "";
  renderSupport();
}

function renderSupport(){
  const container = document.getElementById("supportChat");
  container.innerHTML = "";
  if(currentUser.support) currentUser.support.forEach(m=>{
    const div = document.createElement("div");
    div.textContent = `[${m.time}] ${m.msg}`;
    container.appendChild(div);
  });
}

// ======== Tabellen-Anfragen ========
function requestTables(){
  const n = parseInt(reqTables.value);
  if(!n || n<1) return alert("GÃ¼ltige Zahl eingeben");
  currentUser.requestedTables = n;
  save();
  alert("Anfrage gesendet. Bitte warten, bis Owner genehmigt.");
  reqTables.value = "";
  renderRequests();
}

function renderRequests(){
  const container = document.getElementById("tableRequests");
  container.innerHTML = "";
  if(currentUser.role !== "owner") return;

  users.forEach(u=>{
    if(u.role==="member" && u.requestedTables > 0){
      const div = document.createElement("div");
      div.innerHTML = `${u.name} mÃ¶chte ${u.requestedTables} Tabellen
        <button onclick="approveTables('${u.name}')">Genehmigen</button>
        <button onclick="declineTables('${u.name}')">Ablehnen</button>`;
      container.appendChild(div);
    }
  });
}

function approveTables(userName){
  const u = users.find(x=>x.name===userName);
  if(u){
    u.approvedTables = u.requestedTables;
    u.requestedTables = 0;
    // Tabellen initialisieren, falls leer
    if(!u.tablesData || u.tablesData.length === 0){
      u.tablesData = Array(u.approvedTables).fill(null).map(()=>Array(5).fill(["","","",""]));
    }
    save();
    renderRequests();
    alert(`${userName} wurde genehmigt`);
  }
}

function declineTables(userName){
  const u = users.find(x=>x.name===userName);
  if(u){
    u.requestedTables = 0;
    save();
    renderRequests();
    alert(`${userName} wurde abgelehnt`);
  }
}

// ======== Tabellen rendern ========
function renderMyTables(){
  const container = document.getElementById("myTables");
  container.innerHTML = "";

  if(currentUser.role !== "member") return;

  const n = currentUser.approvedTables || 0;
  if(n === 0){
    container.textContent = "Noch keine Tabellen freigegeben.";
    return;
  }

  for(let t=0; t<n; t++){
    const tbl = document.createElement("table");

    const header = tbl.createTHead();
    const hRow = header.insertRow();
    ["A","B","C","D"].forEach(h=>{
      const th = document.createElement("th");
      th.textContent = h;
      hRow.appendChild(th);
    });

    const tbody = tbl.createTBody();
    // Falls es gespeicherte Daten gibt, benutze diese
    const tData = currentUser.tablesData && currentUser.tablesData[t] ? currentUser.tablesData[t] : Array(5).fill(["","","",""]);
    tData.forEach(rData=>{
      const row = tbody.insertRow();
      rData.forEach(val=>{
        const cell = row.insertCell();
        cell.contentEditable = "true";
        cell.textContent = val;
      });
    });

    container.appendChild(document.createTextNode(`Tabelle ${t+1}`));
    container.appendChild(tbl);
  }
}

// ======== Tabellen speichern ========
function saveTables(){
  if(currentUser.role !== "member") return;
  const tables = [];
  const container = document.getElementById("myTables");
  const htmlTables = container.getElementsByTagName("table");
  for(let tbl of htmlTables){
    const tData = [];
    for(let r=0; r<tbl.rows.length-1; r++){ // skip header
      const rowData = [];
      const cells = tbl.rows[r+1].cells;
      for(let c=0; c<cells.length; c++){
        rowData.push(cells[c].textContent);
      }
      tData.push(rowData);
    }
    tables.push(tData);
  }
  currentUser.tablesData = tables;
  save();
  alert("Tabellen gespeichert!");
}

// ======== Startseite Button ========
function goStart(){
  renderMyTables();
  alert(`Willkommen ${currentUser.name}! Du hast ${currentUser.approvedTables} Tabellen.`);
}

// ======== Dark Mode ========
function toggleDark(){
  document.body.classList.toggle("dark");
  localStorage.setItem("dark", document.body.classList.contains("dark")?"1":"0");
  updateDarkBtn();
}

function updateDarkBtn(){
  const btn = document.getElementById("darkBtn");
  btn.textContent = document.body.classList.contains("dark") ? "â˜€ï¸ Light Mode" : "ðŸŒ™ Dark Mode";
}

function logout(){ location.reload(); }

// ======== Backup ========
function exportData(){
  const d = {users, dark:localStorage.getItem("dark")};
  const b = new Blob([JSON.stringify(d,null,2)],{type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(b);
  a.download = "studio-backup.json";
  a.click();
}

function importData(i){
  const r = new FileReader();
  r.onload = () => {
    const d = JSON.parse(r.result);
    users = d.users||[];
    localStorage.setItem("dark", d.dark||"0");
    save();
    location.reload();
  };
  r.readAsText(i.files[0]);
}
</script>
</body>
</html>
