<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Studio Dashboard</title>
<style>
:root{--bg:#f4f4f9;--card:#fff;--text:#111}
.dark{--bg:#121212;--card:#1e1e1e;--text:#eee}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,Arial;background:var(--bg);color:var(--text);padding:12px}
.container{max-width:900px;margin:auto;background:var(--card);padding:18px;border-radius:14px;box-shadow:0 6px 16px rgba(0,0,0,.25)}
h2,h3{text-align:center}
input,button,select{width:100%;padding:12px;margin:6px 0;border-radius:8px;font-size:15px}
button{background:#4CAF50;color:white;border:none;font-weight:700}
button.red{background:#e74c3c}
button.gray{background:#666}
.hidden{display:none}
.section{margin-top:20px}
.welcome{text-align:center;font-size:22px;font-weight:800}
.inbox-card,.studio-card{border:1px solid #ccc;padding:10px;border-radius:8px;margin-bottom:10px}
.studio-table{width:100%;border-collapse:collapse;margin-top:10px}
.studio-table th,.studio-table td{border:1px solid #ccc;padding:8px;text-align:center}
hr{margin:18px 0}
.status-circle{display:inline-block;width:12px;height:12px;border-radius:50%;margin-right:6px;vertical-align:middle}
.status-online{background:green;}
.status-work{background:orange;}
.status-vacation{background:red;}
.status-neutral{background:blue;}
</style>
</head>

<body>
<div class="container">

<!-- LOGIN -->
<div id="loginBox">
  <h2>Login</h2>
  <input id="loginUser" placeholder="Username">
  <input id="loginPass" type="password" placeholder="Passwort">
  <button onclick="login()">Login</button>
  <div id="loginError" class="hidden" style="color:#b00020;font-weight:700"></div>
  <button class="gray" onclick="requestReset()">ðŸ”‘ Passwort-Reset anfragen</button>
  <hr>
  <h3>User erstellen</h3>
  <input id="quickUser" placeholder="Neuer Username">
  <button onclick="quickCreateUser()">User erstellen (Auto-Passwort)</button>
</div>

<!-- APP -->
<div id="app" class="hidden">
  <div id="welcome" class="welcome"></div>
  <div class="section">
    <button class="gray" onclick="toggleDark()">ðŸŒ™ Dark Mode</button>
  </div>

  <!-- OWNER AREA -->
  <div id="ownerArea" class="section hidden">
    <h3>Inbox</h3>
    <div id="inbox"></div>
    <hr>
    <h3>User anlegen (manuell)</h3>
    <input id="newUser" placeholder="Username">
    <input id="newUserPw" type="password" placeholder="Passwort">
    <button onclick="addUser()">User erstellen</button>
    <hr>
    <h3>Studios erstellen</h3>
    <input id="studioName" placeholder="Studio Name">
    <select id="studioStatus">
      <option value="online">Online</option>
      <option value="work">Auf Arbeit</option>
      <option value="vacation">Urlaub</option>
      <option value="neutral">Neutral</option>
    </select>
    <button onclick="addStudio()">Studio hinzufÃ¼gen</button>
  </div>

  <!-- STUDIOS -->
  <div class="section">
    <h3>Studios Ãœbersicht</h3>
    <table class="studio-table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Status</th>
          <th>Erstellt von</th>
          <th>Aktion</th>
        </tr>
      </thead>
      <tbody id="studioTableBody"></tbody>
    </table>
  </div>
  <button class="red" onclick="logout()">Logout</button>
</div>
</div>

<script>
let users=[];
let inbox=JSON.parse(localStorage.getItem("inbox"))||[];
let studios=JSON.parse(localStorage.getItem("studios"))||[];
let currentUser=null;

/* HASH */
async function sha256(s){
  const b=await crypto.subtle.digest("SHA-256",new TextEncoder().encode(s));
  return [...new Uint8Array(b)].map(x=>x.toString(16).padStart(2,"0")).join("");
}

/* INIT */
(async function(){
  let local=JSON.parse(localStorage.getItem("users"))||[];
  if(!local.length){
    local=[{name:"Owner",role:"owner",pwHash:await sha256("admin")}];
  }
  users=local;
  save();
  loadStudiosTable();
})();

/* LOGIN */
async function login(){
  const u=loginUser.value.trim();
  const p=loginPass.value;
  const f=users.find(x=>x.name===u);
  if(!f||await sha256(p)!==f.pwHash) return fail();

  currentUser=f;
  loginBox.classList.add("hidden");
  app.classList.remove("hidden");
  welcome.textContent=`Willkommen ${f.name}`;
  ownerArea.classList.toggle("hidden",f.role!=="owner");
  loadInbox();
  loadStudiosTable();
}

function fail(){
  loginError.textContent="Login fehlgeschlagen";
  loginError.classList.remove("hidden");
}

/* RESET REQUEST */
function requestReset(){
  const u=prompt("Username eingeben:");
  if(!u) return;
  const user=users.find(x=>x.name===u);
  if(!user) return alert("User nicht gefunden");

  inbox.push({type:"reset", user:u, time:Date.now()});
  save();
  alert("Reset-Anfrage gesendet");
}

/* QUICK USER CREATOR */
async function quickCreateUser(){
  const name = quickUser.value.trim();
  if(!name) return alert("Username fehlt");
  if(users.find(u => u.name === name)) return alert("User existiert bereits");
  const plainPw = "user_" + Date.now();
  users.push({name, role:"user", pwHash: await sha256(plainPw)});
  save();
  alert(`User erstellt!\nUsername: ${name}\nPasswort: ${plainPw}`);
  quickUser.value = "";
}

/* INBOX */
function loadInbox(){
  if(currentUser.role!=="owner") return;
  const inboxContainer = document.getElementById("inbox");
  inboxContainer.innerHTML="";
  inbox.forEach((m,i)=>{
    const d=document.createElement("div");
    d.className="inbox-card";
    if(m.type==="reset"){
      d.innerHTML=`ðŸ”‘ Reset-Anfrage von <b>${m.user}</b><br>
      <button onclick="ownerReset('${m.user}',${i})">Passwort zurÃ¼cksetzen</button>`;
    }
    inboxContainer.appendChild(d);
  });
}

/* OWNER RESET */
async function ownerReset(username,index){
  const u=users.find(x=>x.name===username);
  if(!u) return alert("User existiert nicht mehr");
  const np=prompt("Neues Passwort fÃ¼r "+username+":");
  if(!np) return;
  u.pwHash = await sha256(np);
  inbox.splice(index,1);
  save();
  loadInbox();
  alert("Passwort geÃ¤ndert");
}

/* OWNER MANUELL */
async function addUser(){
  if(!newUser.value||!newUserPw.value) return;
  if(users.find(u => u.name===newUser.value)) return alert("User existiert bereits");
  users.push({name:newUser.value, role:"user", pwHash: await sha256(newUserPw.value)});
  save();
  alert("User erstellt");
  newUser.value=""; newUserPw.value="";
}

/* CREATE STUDIO */
function addStudio(){
  if(!studioName.value) return alert("Studio Name fehlt");
  studios.push({name:studioName.value,status:studioStatus.value,owner:currentUser.name});
  save();
  studioName.value = "";
  loadStudiosTable();
}

/* LOAD STUDIOS */
function loadStudiosTable(){
  const tbody = document.getElementById("studioTableBody");
  tbody.innerHTML="";
  studios.forEach((s,i)=>{
    const tr = document.createElement("tr");
    const statusCircle = `<span class="status-circle ${{
      online:'status-online',work:'status-work',vacation:'status-vacation',neutral:'status-neutral'
    }[s.status]}"></span>${s.status}`;

    let actionBtn = "-";
    if(currentUser.role==="owner" || s.owner === currentUser.name){
      actionBtn = `<button onclick="changeStatus(${i})">Status Ã¤ndern</button>`;
    }

    tr.innerHTML = `<td>${s.name}</td><td>${statusCircle}</td><td>${s.owner}</td><td>${actionBtn}</td>`;
    tbody.appendChild(tr);
  });
}

/* CHANGE STUDIO STATUS */
function changeStatus(index){
  const s = studios[index];
  if(currentUser.role !== "owner" && s.owner !== currentUser.name){
    return alert("Du darfst nur den Status deiner eigenen Studios Ã¤ndern!");
  }
  const newStatus = prompt("Neuer Status fÃ¼r "+s.name+" (online/work/vacation/neutral):", s.status);
  if(!newStatus || !["online","work","vacation","neutral"].includes(newStatus)) return alert("UngÃ¼ltiger Status");

  s.status = newStatus;
  save();
  loadStudiosTable();
}

/* UTIL */
function toggleDark(){
  document.body.classList.toggle("dark");
  localStorage.setItem("dark",document.body.classList.contains("dark")?"1":"0");
}
if(localStorage.getItem("dark")==="1") document.body.classList.add("dark");

function logout(){location.reload();}

function save(){
  localStorage.setItem("users",JSON.stringify(users));
  localStorage.setItem("inbox",JSON.stringify(inbox));
  localStorage.setItem("studios",JSON.stringify(studios));
}
</script>
</body>
</html>
