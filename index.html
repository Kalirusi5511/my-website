<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Studio Dashboard ‚Äì Final Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root {
  --bg: #f4f4f4;
  --card: #fff;
  --text: #111;
  --btn: #4CAF50;
  --btn-h: #45a049;
  --owner: #e74c3c;
  --admin: #9b59b6;
}

body.dark {
  --bg: #121212;
  --card: #1e1e1e;
  --text: #eee;
  --btn: #3498db;
  --btn-h: #2980b9;
}

body {
  margin: 0;
  font-family: sans-serif;
  background: var(--bg);
  color: var(--text);
  padding: 12px;
}

.box {
  max-width: 900px;
  margin: auto;
  background: var(--card);
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 3px 8px rgba(0,0,0,.2);
}

input, select, button {
  width: 100%;
  padding: 10px;
  margin: 6px 0;
  border-radius: 6px;
  font-size: 15px;
}

button {
  background: var(--btn);
  color: #fff;
  border: none;
  font-weight: 700;
  cursor: pointer;
}

button:hover {
  background: var(--btn-h);
}

.hidden {
  display: none;
}

.role-owner {
  color: var(--owner);
  font-weight: 700;
}

.role-admin {
  color: var(--admin);
  font-weight: 700;
}

hr {
  margin: 20px 0;
}

@media(max-width:600px){
  .box{padding:14px}
  input,button{font-size:16px}
}
</style>
</head>
<body>

<div class="box" id="loginBox">
  <h2>Login</h2>
  <input id="loginUser" placeholder="Name">
  <input id="loginPw" type="password" placeholder="Passwort">
  <button onclick="login()">Login</button>

  <h3>Registrieren</h3>
  <input id="regUser" placeholder="Name">
  <input id="regPw" type="password" placeholder="Passwort">
  <button onclick="register()">Registrieren</button>

  <!-- ONE TIME OWNER RECOVERY -->
  <div id="recoveryBox" class="hidden">
    <hr>
    <h3>Owner-Recovery (einmalig)</h3>
    <input id="recoveryKey" placeholder="Recovery-Key">
    <input id="newOwnerPw" type="password" placeholder="Neues Owner-Passwort">
    <button onclick="ownerRecovery()">Recovery ausf√ºhren</button>
  </div>
</div>

<div class="box hidden" id="app">
  <h2 id="welcome"></h2>
  <p>Rolle: <span id="role"></span></p>

  <button id="darkBtn" onclick="toggleDark()">üåô Dark Mode</button>
  <button onclick="logout()">Logout</button>

  <hr>

  <h3>Passwort √§ndern</h3>
  <input id="oldPw" type="password" placeholder="Altes Passwort">
  <input id="newPw" type="password" placeholder="Neues Passwort">
  <button onclick="changePw()">√Ñndern</button>

  <div id="adminArea" class="hidden">
    <hr>
    <h3>Admin / Owner</h3>

    <h4>Passwort zur√ºcksetzen</h4>
    <input id="resetUser" placeholder="Benutzer">
    <input id="resetPw" type="password" placeholder="Neues Passwort">
    <button onclick="resetUserPw()">Reset</button>

    <h4>Backup</h4>
    <button onclick="exportData()">Export</button>
    <input type="file" onchange="importData(this)">
  </div>
</div>

<script>
const DEBUG = false;
const RECOVERY_KEY = "FINAL-OWNER-KEY-2025";

let users = JSON.parse(localStorage.getItem("users")) || [];
let currentUser = null;
const save = () => localStorage.setItem("users", JSON.stringify(users));

async function hash(t){
  const b = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(t));
  return [...new Uint8Array(b)].map(x => x.toString(16).padStart(2,"0")).join("");
}

(async()=>{
  if(!users.some(u=>u.role==="owner")){
    users.push({name:"Owner", role:"owner", pwHash:await hash("1234")});
    localStorage.setItem("ownerRecovery","1");
  }
  save();
  if(localStorage.getItem("ownerRecovery")==="1")
    recoveryBox.classList.remove("hidden");

  // DARK MODE beim Start pr√ºfen
  if(localStorage.getItem("dark")==="1") document.body.classList.add("dark");
  updateDarkBtn();
})();

async function login(){
  const n = loginUser.value.trim().toLowerCase();
  const u = users.find(x=>x.name.toLowerCase()===n);
  if(!u) return alert("User nicht gefunden");
  if(await hash(loginPw.value)!==u.pwHash) return alert("Falsches Passwort");

  currentUser = u;
  loginBox.classList.add("hidden");
  app.classList.remove("hidden");
  welcome.textContent = "Hallo "+u.name;
  role.textContent = u.role;
  role.className = u.role==="owner"?"role-owner":"role-admin";
  adminArea.classList.toggle("hidden", u.role==="member");
}

async function register(){
  const n = regUser.value.trim();
  if(!n) return;
  if(users.some(u=>u.name.toLowerCase()===n.toLowerCase())) return alert("Existiert schon");
  users.push({name:n, role:"member", pwHash:await hash(regPw.value)});
  save();
  alert("Registriert");
}

async function changePw(){
  if(await hash(oldPw.value)!==currentUser.pwHash) return alert("Falsch");
  currentUser.pwHash = await hash(newPw.value);
  save();
  alert("Ge√§ndert");
}

async function resetUserPw(){
  if(currentUser.role==="member") return;
  const u = users.find(x=>x.name===resetUser.value);
  if(!u) return alert("Nicht gefunden");
  if(u.role==="owner" && currentUser.role!=="owner") return alert("Nur Owner");
  u.pwHash = await hash(resetPw.value);
  save();
  alert("Reset OK");
}

async function ownerRecovery(){
  if(recoveryKey.value!==RECOVERY_KEY) return alert("Key falsch");
  const o = users.find(u=>u.role==="owner");
  o.pwHash = await hash(newOwnerPw.value);
  localStorage.removeItem("ownerRecovery");
  recoveryBox.remove();
  save();
  alert("Owner-Passwort neu gesetzt");
}

function exportData(){
  const d = {users, dark:localStorage.getItem("dark")};
  const b = new Blob([JSON.stringify(d,null,2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(b);
  a.download = "studio-backup.json";
  a.click();
}

function importData(i){
  const r = new FileReader();
  r.onload = () => {
    const d = JSON.parse(r.result);
    users = d.users||[];
    localStorage.setItem("dark", d.dark||"0");
    save();
    alert("Import OK ‚Äì neu laden");
    location.reload();
  };
  r.readAsText(i.files[0]);
}

function toggleDark(){
  document.body.classList.toggle("dark");
  localStorage.setItem("dark", document.body.classList.contains("dark") ? "1" : "0");
  updateDarkBtn();
}

// Icon aktualisieren
function updateDarkBtn(){
  const btn = document.getElementById("darkBtn");
  if(document.body.classList.contains("dark")){
    btn.textContent = "‚òÄÔ∏è Light Mode";
  } else {
    btn.textContent = "üåô Dark Mode";
  }
}

function logout(){location.reload()}
</script>
</body>
</html>
