<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Studio Dashboard</title>

<style>
:root{--bg:#f4f4f9;--card:#ffffff;--text:#111}
.dark{--bg:#121212;--card:#1e1e1e;--text:#eee}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,Arial;background:var(--bg);color:var(--text);padding:12px}
.container{max-width:900px;margin:auto;background:var(--card);padding:18px;border-radius:14px;box-shadow:0 6px 16px rgba(0,0,0,.25)}
h2,h3{text-align:center}
input,button,select{width:100%;padding:12px;margin:6px 0;border-radius:8px;font-size:15px}
button{background:#4CAF50;color:white;border:none;font-weight:700}
button.red{background:#e74c3c}
button.gray{background:#666}
.hidden{display:none}
.section{margin-top:20px}
.welcome{text-align:center;font-size:22px;font-weight:800}
.inbox-card{border:1px solid #ccc;padding:10px;border-radius:8px;margin-bottom:10px}
</style>
</head>

<body>
<div class="container">

<!-- LOGIN -->
<div id="loginBox">
  <h2>Login</h2>
  <input id="loginUser" placeholder="Username">
  <input id="loginPass" type="password" placeholder="Passwort">
  <button onclick="login()">Login</button>
  <div id="loginError" class="hidden" style="color:#b00020;font-weight:700"></div>
  <button onclick="startReset()">Passwort vergessen?</button>
</div>

<!-- RESET -->
<div id="resetBox" class="hidden">
  <h3>Passwort zur√ºcksetzen</h3>
  <div id="resetQuestions"></div>
  <input id="resetNewPw" type="password" placeholder="Neues Passwort">
  <button onclick="confirmReset()">Speichern</button>
  <button class="gray" onclick="location.reload()">Abbrechen</button>
</div>

<!-- APP -->
<div id="app" class="hidden">
  <div id="welcome" class="welcome"></div>

  <div class="section">
    <button class="gray" onclick="toggleDark()">üåô Dark Mode</button>
    <button class="gray" onclick="toggleSettings()">‚öôÔ∏è Settings</button>
  </div>

  <!-- SETTINGS -->
  <div id="settingsPanel" class="section hidden">
    <h3>Sicherheitsfragen</h3>
    <input class="secQ" placeholder="Frage 1">
    <input class="secQ" placeholder="Frage 2">
    <input class="secQ" placeholder="Frage 3">
    <button onclick="saveSecurityQuestions()">Speichern</button>
  </div>

  <!-- STUDIOS -->
  <div class="section">
    <h3>Studios</h3>
    <select id="studioSelect"></select>
  </div>

  <!-- USER MESSAGE -->
  <div id="userRequestArea" class="section hidden">
    <button onclick="sendMessage()">Nachricht an Owner senden</button>
  </div>

  <!-- OWNER AREA -->
  <div id="ownerArea" class="section hidden">
    <h3>User anlegen</h3>
    <input id="newUser" placeholder="Username">
    <input id="newUserPw" type="password" placeholder="Passwort">
    <button onclick="addUser()">User erstellen</button>

    <h3>Studio hinzuf√ºgen</h3>
    <input id="newStudio" placeholder="Studio Name">
    <button onclick="addStudio()">Studio hinzuf√ºgen</button>

    <h3>Inbox</h3>
    <div id="inbox"></div>
  </div>

  <button class="red" onclick="logout()">Logout</button>
</div>
</div>

<script>
let users=[], studios=JSON.parse(localStorage.getItem("studios"))||[];
let inbox=JSON.parse(localStorage.getItem("inbox"))||[];
let currentUser=null, resetUser=null;

/* HASH */
async function sha256(s){
  const b=await crypto.subtle.digest("SHA-256",new TextEncoder().encode(s));
  return [...new Uint8Array(b)].map(x=>x.toString(16).padStart(2,"0")).join("");
}

/* INIT + MIGRATION */
(async function(){
  let local=JSON.parse(localStorage.getItem("users"))||[];
  if(!local.length){
    local=[{name:"Owner",role:"owner",pwHash:await sha256("admin"),securityQuestions:[],securityAnswers:[]}];
  }
  for(const u of local){
    if(u.pw){u.pwHash=await sha256(u.pw);delete u.pw;}
    u.securityQuestions??=[];u.securityAnswers??=[];
    u.securityAnswers=await Promise.all(u.securityAnswers.map(a=>a.length===64?a:sha256(a)));
  }
  users=local;save();
})();

/* LOGIN */
async function login(){
  const u=loginUser.value.trim(),p=loginPass.value;
  const f=users.find(x=>x.name===u);
  if(!f||await sha256(p)!==f.pwHash)return fail();
  currentUser=f;
  loginBox.classList.add("hidden");
  app.classList.remove("hidden");
  welcome.textContent=`Willkommen ${f.name}`;
  ownerArea.classList.toggle("hidden",f.role!=="owner");
  userRequestArea.classList.toggle("hidden",f.role==="owner");
  loadStudios(); loadInbox(); loadSettings();
}

/* RESET */
function startReset(){
  const n=prompt("Username:");
  resetUser=users.find(u=>u.name===n);
  if(!resetUser||!resetUser.securityQuestions.length)return alert("Nicht m√∂glich");
  loginBox.classList.add("hidden"); resetBox.classList.remove("hidden");
  resetQuestions.innerHTML="";
  resetUser.securityQuestions.forEach((q,i)=>{
    const inp=document.createElement("input");inp.placeholder=q;inp.dataset.i=i;
    resetQuestions.appendChild(inp);
  });
}
async function confirmReset(){
  for(const i of resetQuestions.querySelectorAll("input")){
    if(await sha256(i.value)!==resetUser.securityAnswers[i.dataset.i])return alert("Falsch");
  }
  resetUser.pwHash=await sha256(resetNewPw.value); save(); location.reload();
}

/* SETTINGS */
function toggleSettings(){settingsPanel.classList.toggle("hidden");}
function loadSettings(){
  document.querySelectorAll(".secQ").forEach((i,idx)=>i.value=currentUser.securityQuestions[idx]||"");
}
async function saveSecurityQuestions(){
  const q=[...document.querySelectorAll(".secQ")].map(i=>i.value);
  currentUser.securityQuestions=q;
  currentUser.securityAnswers=await Promise.all(q.map(a=>a?sha256(a):""));
  save(); alert("Gespeichert");
}

/* STUDIOS */
function loadStudios(){
  studioSelect.innerHTML="";
  studios.forEach(s=>{const o=document.createElement("option");o.textContent=s;studioSelect.appendChild(o);});
}
function addStudio(){studios.push(newStudio.value);save();loadStudios();}

/* INBOX */
function sendMessage(){
  const m=prompt("Nachricht:");
  inbox.push({from:currentUser.name,msg:m}); save(); alert("Gesendet");
}
function loadInbox(){
  if(currentUser.role!=="owner")return;
  inbox.innerHTML="";
  inbox.forEach((m,i)=>{
    const d=document.createElement("div");d.className="inbox-card";
    d.textContent=`${m.from}: ${m.msg}`;
    inbox.appendChild(d);
  });
}

/* OWNER */
async function addUser(){
  users.push({name:newUser.value,role:"user",pwHash:await sha256(newUserPw.value),securityQuestions:[],securityAnswers:[]});
  save(); alert("User erstellt");
}

/* UTIL */
function toggleDark(){document.body.classList.toggle("dark");localStorage.setItem("dark",document.body.classList.contains("dark")?"1":"0");}
if(localStorage.getItem("dark")==="1")document.body.classList.add("dark");
function fail(){loginError.textContent="Login fehlgeschlagen";loginError.classList.remove("hidden");}
function logout(){location.reload();}
function save(){
  localStorage.setItem("users",JSON.stringify(users));
  localStorage.setItem("studios",JSON.stringify(studios));
  localStorage.setItem("inbox",JSON.stringify(inbox));
}
</script>
</body>
</html>
