<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Studio Dashboard</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
:root{--bg:#f4f4f4;--card:#fff;--text:#111;--btn:#4CAF50;--btn-hover:#45a049;}
.dark{--bg:#121212;--card:#1e1e1e;--text:#eee;--btn:#3498db;--btn-hover:#2980b9;}
body{font-family:sans-serif;background:var(--bg);color:var(--text);padding:12px}
.box{max-width:600px;margin:auto;background:var(--card);padding:20px;border-radius:10px;box-shadow:0 3px 8px rgba(0,0,0,0.2);}
input,select,button{padding:10px;margin:5px 0;width:100%;border-radius:6px;font-size:15px;}
button{background:var(--btn);color:#fff;border:none;font-weight:700;cursor:pointer;}
button:hover{background:var(--btn-hover);}
.hidden{display:none;}
h2,h3{text-align:center;margin-top:0;}
.status-circle{display:inline-block;width:12px;height:12px;border-radius:50%;margin-right:8px;}
.status-im{background:#2ecc71;}
.status-abwesend{background:#f1c40f;}
.status-test{background:#3498db;}
.status-urlaub{background:#e74c3c;}
</style>
</head>
<body>

<div class="box" id="loginBox">
  <h2>Login</h2>
  <input id="user" placeholder="Name">
  <input id="pass" type="password" placeholder="Passwort">
  <button onclick="login()">Login</button>

  <h3>Registrieren</h3>
  <input id="ru" placeholder="Name">
  <input id="rp" type="password" placeholder="Passwort">
  <select id="registerStudioSelect">
    <option value="">Neues Studio erstellen</option>
  </select>
  <input id="registerNewStudio" placeholder="Name des neuen Studios">
  <button onclick="register()">Registrieren</button>
</div>

<div class="box hidden" id="app">
  <h2 id="welcome"></h2>
  <p>Rolle: <b id="roleText"></b></p>
  <button onclick="goAdmin()">Admin-Panel</button>
  <button onclick="toggleDark()">ðŸŒ™ Dark Mode</button>
  <button onclick="logout()">Logout</button>

  <hr>

  <h3>Studios</h3>
  <select id="studioSelect"></select>
  <input id="userNewStudio" placeholder="Neues Studio erstellen">
  <button onclick="addUserStudio()">Studio erstellen</button>
  <button onclick="editUserStudio()">Studio bearbeiten</button>

  <div id="userStudioStatus" class="hidden">
    <h4>Mein Status</h4>
    <select id="userStatusSelect" onchange="setUserStatus()">
      <option>Im Studio</option>
      <option>Abwesend</option>
      <option>Im Test-System</option>
      <option>Urlaub</option>
    </select>
  </div>

  <div id="studioUsers" class="hidden">
    <h4>Mitglieder</h4>
    <ul id="studioUserList"></ul>
  </div>

  <div id="studioMessage" class="hidden">
    <h4>Nachricht senden</h4>
    <input id="msgText" placeholder="Nachricht">
    <button onclick="sendStudioMessage()">Senden</button>
  </div>

  <div id="studioMessages" class="hidden">
    <h4>Studio-Nachrichten</h4>
    <ul id="msgList"></ul>
  </div>

  <button id="leaveStudioBtn" class="hidden" onclick="leaveStudio()">Studio verlassen</button>

  <hr>

  <div id="pwResetArea">
    <h3>Passwort Ã¤ndern</h3>
    <input id="oldPw" type="password" placeholder="Altes Passwort">
    <input id="newPw" type="password" placeholder="Neues Passwort">
    <button onclick="changePw()">Ã„ndern</button>
  </div>
</div>

<script>
let users = JSON.parse(localStorage.getItem('users')) || [];
let studios = JSON.parse(localStorage.getItem('studios')) || [];
let currentUser = null;

const save = ()=>{ 
  localStorage.setItem('users',JSON.stringify(users)); 
  localStorage.setItem('studios',JSON.stringify(studios)); 
};

async function hash(str){ 
  const buf = await crypto.subtle.digest("SHA-256",new TextEncoder().encode(str)); 
  return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
}

// ===== INIT OWNER & HASH EXISTING USERS =====
(async()=>{
  for(let u of users){
    if(u.pw && !u.pwHash){
      u.pwHash = await hash(u.pw);
      delete u.pw;
    }
  }
  // Owner nur einmal anlegen, wenn noch nicht vorhanden
  if(!users.find(u=>u.role==='owner')){
    users.push({name:'Owner',role:'owner',pwHash:await hash('1234')});
    save();
  }
})();

// ===== LOGIN =====
async function login(){
  let u = users.find(x=>x.name===user.value);
  if(!u && user.value.toLowerCase()==='owner') u = users.find(x=>x.role==='owner');
  if(!u || await hash(pass.value)!==u.pwHash) return alert("Login falsch");
  currentUser=u;
  loginBox.classList.add('hidden'); app.classList.remove('hidden');
  welcome.textContent = "Hallo "+u.name; roleText.textContent = u.role;
  loadStudios(); loadStudiosForRegister();
}

// ===== REGISTER =====
async function register(){
  if(users.some(x=>x.name===ru.value)) return alert("User existiert");
  const newUser = {name:ru.value,role:'member',pwHash:await hash(rp.value)};
  
  const selectedStudio = document.getElementById('registerStudioSelect').value;
  const newStudioName = document.getElementById('registerNewStudio').value.trim();
  
  if(newStudioName) {
    const studio = {id:Date.now(), name:newStudioName, users:[{name:ru.value,status:'Im Studio'}], messages:[]};
    studios.push(studio);
  } else if(selectedStudio) {
    const studio = studios.find(s => s.id == selectedStudio);
    if(studio) studio.users.push({name:ru.value,status:'Im Studio'});
  }

  users.push(newUser);
  save(); alert("Registriert und Studio zugewiesen");
  loadStudiosForRegister();
}

// ===== ADMIN NAV =====
function goAdmin(){ if(currentUser.role==='member') return alert("Kein Zugriff"); location.href="admin.html"; }
function logout(){location.reload();}

// ===== DARK MODE =====
function toggleDark(){ document.body.classList.toggle('dark'); localStorage.setItem('dark',document.body.classList.contains('dark')?'1':'0'); }
if(localStorage.getItem('dark')==='1') document.body.classList.add('dark');

// ===== PASSWORD CHANGE =====
async function changePw(){
  if(await hash(oldPw.value)!==currentUser.pwHash) return alert("Falsches Passwort");
  currentUser.pwHash = await hash(newPw.value);
  save();
  alert("Passwort geÃ¤ndert");
}

// ===== STUDIOS =====
function loadStudios(){
  studioSelect.innerHTML='';
  studios.forEach(s=>{
    const o = document.createElement('option'); o.value=s.id; o.textContent=s.name;
    studioSelect.appendChild(o);
  });
  if(studios.length>0){ showUserStudioSections(); renderStudioUsers(); renderStudioMessages(); }
}

function loadStudiosForRegister(){
  const sel = document.getElementById('registerStudioSelect');
  sel.innerHTML = '<option value="">Neues Studio erstellen</option>';
  studios.forEach(s=>{
    const o = document.createElement('option'); o.value=s.id; o.textContent=s.name;
    sel.appendChild(o);
  });
}

function addUserStudio(){
  const name = userNewStudio.value.trim();
  if(!name) return alert("Gib Name ein!");
  const newStudio = {id:Date.now(),name:name,users:[{name:currentUser.name,status:'Im Studio'}],messages:[]};
  studios.push(newStudio); save(); userNewStudio.value=''; loadStudios();
  studioSelect.value=newStudio.id; showUserStudioSections(); renderStudioUsers(); renderStudioMessages();
}

function editUserStudio(){
  const studio = studios.find(s => s.id == studioSelect.value);
  if(!studio) return alert("Kein Studio ausgewÃ¤hlt");
  const newName = prompt("Neuer Studio-Name:", studio.name);
  if(newName && newName.trim() !== "") { studio.name = newName.trim(); save(); loadStudios(); alert("Studio-Name geÃ¤ndert"); }
}

function setUserStatus(){
  const studio = studios.find(s=>s.id==studioSelect.value); if(!studio) return;
  let entry = studio.users.find(u=>u.name===currentUser.name); 
  if(!entry) { entry={name:currentUser.name,status:'Im Studio'}; studio.users.push(entry);}
  entry.status=userStatusSelect.value; save(); renderStudioUsers();
}

function renderStudioUsers(){
  const studio = studios.find(s=>s.id==studioSelect.value); if(!studio) return;
  studioUsers.classList.remove('hidden'); studioUserList.innerHTML='';
  studio.users.forEach(u=>{
    const li=document.createElement('li'); const c=document.createElement('span'); c.className='status-circle';
    if(u.status==='Im Studio') c.classList.add('status-im');
    else if(u.status==='Abwesend') c.classList.add('status-abwesend');
    else if(u.status==='Im Test-System') c.classList.add('status-test');
    else if(u.status==='Urlaub') c.classList.add('status-urlaub');
    li.appendChild(c); li.appendChild(document.createTextNode(u.name+" - "+u.status)); studioUserList.appendChild(li);
  });
  studioMessage.classList.remove('hidden'); studioMessages.classList.remove('hidden'); userStudioStatus.classList.remove('hidden'); leaveStudioBtn.classList.remove('hidden');
}

function sendStudioMessage(){
  const text = msgText.value.trim(); if(!text) return alert("Nachricht eingeben!");
  const studio = studios.find(s=>s.id==studioSelect.value); if(!studio.messages) studio.messages=[];
  studio.messages.push({from:currentUser.name,text,time:Date.now()}); save(); msgText.value=''; renderStudioMessages();
}

function renderStudioMessages(){
  const studio = studios.find(s=>s.id==studioSelect.value); if(!studio || !studio.messages) return;
  msgList.innerHTML=''; studioMessages.classList.remove('hidden');
  studio.messages.forEach(m=>{
    const li=document.createElement('li'); li.textContent=`[${new Date(m.time).toLocaleTimeString()}] ${m.from}: ${m.text}`; msgList.appendChild(li);
  });
}

function leaveStudio(){
  const studio=studios.find(s=>s.id==studioSelect.value); if(!studio) return;
  studio.users = studio.users.filter(u=>u.name!==currentUser.name); save(); renderStudioUsers();
  alert("Verlassen"); studioUsers.classList.add('hidden'); studioMessages.classList.add('hidden'); userStudioStatus.classList.add('hidden'); leaveStudioBtn.classList.add('hidden');
}

studioSelect.onchange = ()=>{
  const studio = studios.find(s=>s.id==studioSelect.value); if(!studio) return;
  const entry = studio.users.find(u=>u.name===currentUser.name);
  userStatusSelect.value=entry?entry.status:'Im Studio';
  renderStudioUsers(); renderStudioMessages();
};

function showUserStudioSections(){ userStudioStatus.classList.remove('hidden'); studioUsers.classList.remove('hidden'); studioMessage.classList.remove('hidden'); studioMessages.classList.remove('hidden'); leaveStudioBtn.classList.remove('hidden'); }
</script>

</body>
</html>
