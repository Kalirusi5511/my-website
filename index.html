<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Studio Dashboard</title>

<style>
:root{--bg:#f4f4f9;--card:#fff;--text:#111}
.dark{--bg:#121212;--card:#1e1e1e;--text:#eee}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui;background:var(--bg);color:var(--text);padding:12px}
.container{max-width:900px;margin:auto;background:var(--card);padding:18px;border-radius:14px;box-shadow:0 6px 16px rgba(0,0,0,.25)}
h2,h3{text-align:center}
input,button,select{width:100%;padding:12px;margin:6px 0;border-radius:8px}
button{background:#4CAF50;color:#fff;border:none;font-weight:700}
button.red{background:#e74c3c}
button.gray{background:#666}
.hidden{display:none}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ccc;padding:8px;text-align:center}
.status-circle{width:12px;height:12px;border-radius:50%;display:inline-block;margin-right:6px}
.status-online{background:green}
.status-work{background:orange}
.status-vacation{background:red}
.status-neutral{background:blue}
</style>
</head>

<body>
<div class="container">

<!-- LOGIN -->
<div id="loginBox">
  <h2>Login</h2>
  <input id="loginUser" placeholder="Username">
  <input id="loginPass" type="password" placeholder="Passwort">
  <button onclick="login()">Login</button>
  <div id="loginError" class="hidden" style="color:#b00020;font-weight:700"></div>
</div>

<!-- 2FA -->
<div id="twofaBox" class="hidden">
  <h2>Owner 2FA</h2>
  <input id="twofaPin" type="password" placeholder="6-stellige PIN">
  <button onclick="verify2FA()">BestÃ¤tigen</button>
</div>

<!-- APP -->
<div id="app" class="hidden">
  <div id="welcome" style="text-align:center;font-size:22px;font-weight:800"></div>
  <button class="gray" onclick="toggleDark()">ðŸŒ™ Dark Mode</button>

  <!-- OWNER -->
  <div id="ownerArea" class="hidden">
    <h3>Owner Reset (Master)</h3>
    <input id="masterPw" type="password" placeholder="Master-Passwort">
    <button onclick="ownerMasterReset()">Owner Passwort neu setzen</button>
    <div id="newOwnerPwDisplay" class="hidden" style="color:green;font-weight:700"></div>

    <h3>Studio erstellen</h3>
    <input id="studioName" placeholder="Studio Name">
    <select id="studioStatus">
      <option value="online">Online</option>
      <option value="work">Auf Arbeit</option>
      <option value="vacation">Urlaub</option>
      <option value="neutral">Neutral</option>
    </select>
    <button onclick="addStudio()">Studio hinzufÃ¼gen</button>
  </div>

  <h3>Studios</h3>
  <table>
    <thead><tr><th>Name</th><th>Status</th><th>Owner</th><th>Aktion</th></tr></thead>
    <tbody id="studioTable"></tbody>
  </table>

  <button class="red" onclick="logout()">Logout</button>
</div>
</div>

<script>
/* ========= CONFIG ========= */
const MASTER_PASSWORD = "supersecure123";
const SECURITY_INTERVAL = 5000;
const OWNER_2FA_TIMEOUT = 5 * 60 * 1000;

/* ========= STATE ========= */
let users = JSON.parse(localStorage.getItem("users")) || [];
let studios = JSON.parse(localStorage.getItem("studios")) || [];
let session = JSON.parse(localStorage.getItem("session"));
let currentUser = null;

/* ========= HASH ========= */
async function sha256(s){
  const b = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(s));
  return [...new Uint8Array(b)].map(x=>x.toString(16).padStart(2,"0")).join("");
}

/* ========= INIT ========= */
(async()=>{
  if(!users.find(u=>u.name==="Owner")){
    users.push({name:"Owner",role:"owner",pwHash:await sha256("admin"),pinHash:null});
    save();
  }
  restoreSession();
  startSecurityWatchdog();
})();

/* ========= LOGIN ========= */
async function login(){
  const u=loginUser.value.trim(), p=loginPass.value;

  if(u==="Owner" && p===MASTER_PASSWORD){
    startSession(users.find(x=>x.name==="Owner"));
    return;
  }

  const f=users.find(x=>x.name===u);
  if(!f||await sha256(p)!==f.pwHash){
    loginError.textContent="Login fehlgeschlagen";
    loginError.classList.remove("hidden");
    return;
  }
  startSession(f);
}

function startSession(user){
  currentUser=user;
  session={token:crypto.randomUUID(),user:user.name,role:user.role,time:Date.now()};
  localStorage.setItem("session",JSON.stringify(session));

  if(user.role==="owner"){
    require2FA();
  } else {
    showApp();
  }
}

/* ========= 2FA ========= */
function require2FA(){
  loginBox.classList.add("hidden");
  twofaBox.classList.remove("hidden");
}

async function verify2FA(){
  const pin=twofaPin.value.trim();
  if(pin.length<4) return alert("PIN ungÃ¼ltig");

  if(!currentUser.pinHash){
    currentUser.pinHash=await sha256(pin);
    save();
  } else if(await sha256(pin)!==currentUser.pinHash){
    return alert("Falsche PIN");
  }

  session.twofaUntil=Date.now()+OWNER_2FA_TIMEOUT;
  localStorage.setItem("session",JSON.stringify(session));
  twofaBox.classList.add("hidden");
  showApp();
}

/* ========= SESSION RESTORE ========= */
function restoreSession(){
  if(!session) return;
  const u=users.find(x=>x.name===session.user);
  if(!u||u.role!==session.role) return forceLogout();
  currentUser=u;

  if(u.role==="owner" && (!session.twofaUntil || Date.now()>session.twofaUntil)){
    require2FA();
  } else {
    showApp();
  }
}

/* ========= SECURITY WATCHDOG ========= */
function startSecurityWatchdog(){
  setInterval(()=>{
    const s=JSON.parse(localStorage.getItem("session"));
    if(!s) return forceLogout();
    const u=users.find(x=>x.name===s.user);
    if(!u||u.role!==s.role) forceLogout();
    if(u.role==="owner" && Date.now()>s.twofaUntil) forceLogout();
  },SECURITY_INTERVAL);
}

/* ========= OWNER RESET ========= */
async function ownerMasterReset(){
  if(masterPw.value!==MASTER_PASSWORD) return alert("Falsches Master-Passwort");
  const owner=users.find(u=>u.role==="owner");
  const np="owner_"+Date.now();
  owner.pwHash=await sha256(np);
  save();
  newOwnerPwDisplay.textContent="Neues Owner Passwort: "+np;
  newOwnerPwDisplay.classList.remove("hidden");
}

/* ========= STUDIOS ========= */
function addStudio(){
  studios.push({name:studioName.value,status:studioStatus.value,owner:currentUser.name});
  save(); loadStudios();
}

function loadStudios(){
  studioTable.innerHTML="";
  studios.forEach((s,i)=>{
    const can=currentUser.role==="owner"||currentUser.name===s.owner;
    studioTable.innerHTML+=`
    <tr>
      <td>${s.name}</td>
      <td><span class="status-circle status-${s.status}"></span>${s.status}</td>
      <td>${s.owner}</td>
      <td>${can?`<button onclick="changeStatus(${i})">Ã„ndern</button>`:"-"}</td>
    </tr>`;
  });
}

function changeStatus(i){
  const ns=prompt("online/work/vacation/neutral",studios[i].status);
  if(["online","work","vacation","neutral"].includes(ns)){
    studios[i].status=ns; save(); loadStudios();
  }
}

/* ========= UI ========= */
function showApp(){
  loginBox.classList.add("hidden");
  twofaBox.classList.add("hidden");
  app.classList.remove("hidden");
  welcome.textContent="Willkommen "+currentUser.name;
  ownerArea.classList.toggle("hidden",currentUser.role!=="owner");
  loadStudios();
}

function toggleDark(){
  document.body.classList.toggle("dark");
  localStorage.setItem("dark",document.body.classList.contains("dark")?"1":"0");
}
if(localStorage.getItem("dark")==="1") document.body.classList.add("dark");

/* ========= LOGOUT ========= */
function logout(){forceLogout();}
function forceLogout(){
  localStorage.removeItem("session");
  location.reload();
}

function save(){
  localStorage.setItem("users",JSON.stringify(users));
  localStorage.setItem("studios",JSON.stringify(studios));
}
</script>
</body>
</html>
